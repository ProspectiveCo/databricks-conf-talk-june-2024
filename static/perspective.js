var D=Object.create;var m=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var P=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var J=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),B=(r,e)=>{for(var t in e)m(r,t,{get:e[t],enumerable:!0})},H=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of X(e))!Q.call(r,s)&&s!==t&&m(r,s,{get:()=>e[s],enumerable:!(n=K(e,s))||n.enumerable});return r};var R=(r,e,t)=>(t=r!=null?D(P(r)):{},H(e||!r||!r.__esModule?m(t,"default",{value:r,enumerable:!0}):t,r));var L=J((Se,q)=>{"use strict";q.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}});var O={};B(O,{COLUMN_SEPARATOR_STRING:()=>le,CONFIG_ALIASES:()=>te,CONFIG_VALID_KEYS:()=>re,DATA_TYPES:()=>ee,FILTER_OPERATORS:()=>o,SORT_ORDERS:()=>ie,SORT_ORDER_IDS:()=>se,TYPE_AGGREGATES:()=>oe,TYPE_FILTERS:()=>ce});var ee={integer:"integer",float:"float",string:"string",boolean:"boolean",date:"date",datetime:"datetime",object:"object"},te={row_pivot:"group_by","row-pivot":"group_by","row-pivots":"group_by",col_pivot:"split_by",col_pivots:"split_by",column_pivot:"split_by","column-pivot":"split_by","column-pivots":"split_by",filters:"filter",sorts:"sort"},re=["version","viewport","group_by","split_by","aggregates","columns","filter","sort","computed_columns","expressions","group_by_depth","split_by_depth","filter_op"],x=["any","avg","abs sum","count","distinct count","dominant","first by index","last by index","last minus first","last","high","join","low","high minus low","max","mean","median","min","pct sum parent","pct sum grand total","stddev","sum","sum abs","sum not null","unique","var"],k=["any","count","distinct count","distinct leaf","dominant","first by index","join","last by index","last","unique"],ne=["any","count","distinct count","distinct leaf","dominant","first by index","last by index","last","unique"],ie=["none","asc","desc","col asc","col desc","asc abs","desc abs","col asc abs","col desc abs"],se=[2,0,1,0,1,3,4,3,4],oe={string:k,float:x,integer:x,boolean:ne,datetime:k,date:k},o={lessThan:"<",greaterThan:">",equals:"==",lessThanOrEquals:"<=",greaterThanOrEquals:">=",doesNotEqual:"!=",isNull:"is null",isNotNull:"is not null",isIn:"in",isNotIn:"not in",contains:"contains",bitwiseAnd:"&",bitwiseOr:"|",and:"and",or:"or",beginsWith:"begins with",endsWith:"ends with"},ae=[o.bitwiseAnd,o.bitwiseOr,o.equals,o.doesNotEqual,o.or,o.and,o.isNull,o.isNotNull],M=[o.lessThan,o.greaterThan,o.equals,o.lessThanOrEquals,o.greaterThanOrEquals,o.doesNotEqual,o.isNull,o.isNotNull],ue=[o.equals,o.contains,o.doesNotEqual,o.isIn,o.isNotIn,o.beginsWith,o.endsWith,o.isNull,o.isNotNull],F=[o.lessThan,o.greaterThan,o.equals,o.lessThanOrEquals,o.greaterThanOrEquals,o.doesNotEqual,o.isNull,o.isNotNull],le="|",ce={string:ue,float:M,integer:M,boolean:ae,datetime:F,date:F};var w={types:{float:{filter_operator:"==",aggregate:"sum",format:{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}},string:{filter_operator:"==",aggregate:"count"},integer:{filter_operator:"==",aggregate:"sum",format:{}},boolean:{filter_operator:"==",aggregate:"count"},datetime:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short",timeStyle:"medium"},null_value:-1},date:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short"},null_value:-1}}};function V(r){let e={};if(y().types[r]&&Object.assign(e,y().types[r]),e.type){let t=V(e.type);return Object.assign(t,e),t}else return e}function b(r){return r&&typeof r=="object"&&!Array.isArray(r)}function A(r,...e){if(!e.length)return r;let t=e.shift();if(b(r)&&b(t))for(let n in t)b(t[n])?(r[n]||Object.assign(r,{[n]:{}}),A(r[n],t[n])):Object.assign(r,{[n]:t[n]});return A(r,...e)}function W(r){globalThis.__PERSPECTIVE_CONFIG__&&console.warn("Config already initialized!"),globalThis.__PERSPECTIVE_CONFIG__=A(w,r)}function y(){return globalThis.__PERSPECTIVE_CONFIG__||(globalThis.__PERSPECTIVE_CONFIG__=A(w,globalThis.__TEMPLATE_CONFIG__||{})),globalThis.__PERSPECTIVE_CONFIG__}var Z=new WeakMap,N=0;function d(r,e){return function(){let t,n=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let f=s.length-1;f>=0;f--)typeof s[f]=="function"&&(t=s.splice(f,1)[0]);let l=Z.get(t);Z.delete(t);let c={cmd:e||"view_method",name:this._name,method:r,args:s,subscribe:!0,callback_id:l};this._worker.post(c,t,n),this._worker.unsubscribe(e,t)}}function _(r,e){return function(){let t,n=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let c=s.length-1;c>=0;c--)typeof s[c]=="function"&&(t=s.splice(c,1)[0]);N++,Z.set(t,N);let l={cmd:e||"view_method",name:this._name,method:r,args:s,subscribe:!0,callback_id:N};this._worker.post(l,t,n,!0)}}function i(r,e){return function(){var t=Array.prototype.slice.call(arguments,0,arguments.length);return new Promise(function(n,s){var l={cmd:e||"view_method",name:this._name,method:r,args:t,subscribe:!1};this._worker.post(l,n,s)}.bind(this))}}function a(r,e,t){return new Promise((n,s)=>{this._worker=r,this._name=Math.random()+"",this._worker.post({cmd:"view",view_name:this._name,table_name:e,config:t},()=>{n(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&n(this)})}function fe(r,e){this._worker=r,this._name=e}fe.prototype=a.prototype;a.prototype.get_config=i("get_config");a.prototype.get_min_max=i("get_min_max");a.prototype.to_json=i("to_json");a.prototype.to_arrow=i("to_arrow");a.prototype.to_columns=i("to_columns");a.prototype.to_columns_string=i("to_columns_string");a.prototype.to_csv=i("to_csv");a.prototype.schema=i("schema");a.prototype.expression_schema=i("expression_schema");a.prototype.column_paths=i("column_paths");a.prototype.num_columns=i("num_columns");a.prototype.num_rows=i("num_rows");a.prototype.dimensions=i("dimensions");a.prototype.set_depth=i("set_depth");a.prototype.get_row_expanded=i("get_row_expanded");a.prototype.expand=i("expand");a.prototype.collapse=i("collapse");a.prototype.delete=i("delete");a.prototype.col_to_js_typed_array=i("col_to_js_typed_array");a.prototype.on_update=_("on_update","view_method",!0);a.prototype.remove_update=d("remove_update","view_method",!0);a.prototype.on_delete=_("on_delete","view_method",!0);a.prototype.remove_delete=d("remove_delete","view_method",!0);function p(r){let e=r;do for(let t of Object.getOwnPropertyNames(e)){let n=r[t];t!=="constructor"&&typeof n=="function"&&(r[t]=n.bind(r))}while(e=e!==Object&&Object.getPrototypeOf(e))}String.prototype.includes||(String.prototype.includes=function(r,e){return typeof e!="number"&&(e=0),e+r.length>this.length?!1:this.indexOf(r,e)!==-1});Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(r,e){if(this==null)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if(n===0)return!1;var s=e|0,l=Math.max(s>=0?s:n-Math.abs(s),0);function c(f,j){return f===j||typeof f=="number"&&typeof j=="number"&&isNaN(f)&&isNaN(j)}for(;l<n;){if(c(t[l],r))return!0;l++}return!1}});function u(r,e,t){return new Promise((n,s)=>{this._worker=r,this._name=t.name||Math.random()+"",p(this),e.to_arrow?(this._worker.post({cmd:"table",name:this._name,args:[],options:t||{}}),e.to_arrow().then(l=>{this._worker.post({cmd:"table",name:this._name,args:[l],options:t||{}},()=>{e.on_update(c=>{this.update(c.delta)},{mode:"row"}),n(this)},s)})):this._worker.post({cmd:"table",name:this._name,args:[e],options:t||{}},()=>{n(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&n(this)})}u.prototype.type="table";function z(r,e){this._worker=r,this._name=e}z.prototype=u.prototype;u.prototype.view=function(r){return new a(this._worker,this._name,r)};u.prototype.query_columns=i("query_columns","table_method");u.prototype.get_index=i("get_index","table_method");u.prototype.get_limit=i("get_limit","table_method");u.prototype.get_num_views=i("get_num_views","table_method");u.prototype.make_port=i("make_port","table_method");u.prototype.remove_port=i("remove_port","table_method");u.prototype.schema=i("schema","table_method");u.prototype.validate_expressions=i("validate_expressions","table_method");u.prototype.is_valid_filter=i("is_valid_filter","table_method");u.prototype.size=i("size","table_method");u.prototype.num_rows=i("num_rows","table_method");u.prototype.num_columns=i("num_columns","table_method");u.prototype.columns=i("columns","table_method");u.prototype.clear=i("clear","table_method");u.prototype.replace=i("replace","table_method");u.prototype.delete=i("delete","table_method");u.prototype.on_delete=_("on_delete","table_method",!0);u.prototype.remove=i("remove","table_method");u.prototype.remove_delete=d("remove_delete","table_method",!0);u.prototype.update=function(r,e){return new Promise((t,n)=>{this._worker.post({name:this._name,cmd:"table_method",method:"update",args:[r,e||{}]},t,n,!1)})};u.prototype.execute=function(r){this._worker.post({cmd:"table_execute",name:this._name,f:r.toString()})};var h=class{constructor(){this._initialized=!1,this._worker={initialized:{value:!1},transferable:!1,msg_id:0,handlers:{},messages:[]},p(this)}unsubscribe(e,t){for(let n of Object.keys(this._worker.handlers))this._worker.handlers[n].resolve===t&&delete this._worker.handlers[n]}post(e,t,n,s=!1){++this._worker.msg_id,(t||n)&&(this._worker.handlers[this._worker.msg_id]={resolve:t,reject:n,keep_alive:s}),e.id=this._worker.msg_id,this._worker.initialized.value?this.send(e):this._worker.messages.push(()=>{this.send(e),(e.cmd==="table"||e.cmd==="view")&&!this._features?.wait_for_response&&t&&t()})}async memory_usage(){return await new Promise((e,t)=>{this.post({cmd:"memory_usage"},e,t)})}async get_hosted_table_names(){return await new Promise((e,t)=>{this.post({cmd:"get_hosted_table_names"},e,t)})}initialize_profile_thread(){this._worker.initialized.value?this.send({id:-1,cmd:"init_profile_thread"}):this._worker.messages.push(()=>this.send({id:-1,cmd:"init_profile_thread"}))}send(){throw new Error("send() not implemented")}async open_table(e){return new z(this,e)}_handle(e){if(!this._worker.initialized.value){this._initialized||(this._initialized=!0);let t=this._worker.messages;if(this._worker.initialized.value=!0,this._worker.messages=[],e.data?.data){this._features={};for(let n of e.data.data)this._features[n]=!0}if(t)for(let n in t)t.hasOwnProperty(n)&&t[n]()}if(e.data.id){let t=this._worker.handlers[e.data.id];t&&(e.data.error?t.reject(e.data.error):t.resolve(e.data.data),t.keep_alive||delete this._worker.handlers[e.data.id])}}table(e,t){return new u(this,e,t||{})}terminate(){this._worker.terminate(),this._worker=void 0}};var U=R(L()),he=3e4,g=class extends h{_ping(){this._ping_loop&&this._ws.send("ping"),this._ping_loop=setTimeout(this._ping.bind(this),he)}_close(){clearTimeout(this._ping_loop),this._ping_loop=void 0,this._on_close_callback?.()}_onmessage(e){if(e.data!=="pong")if(this._pending_binary){let t=e.data;if(this._full_binary.set(new Uint8Array(t),this._total_chunk_length),this._total_chunk_length+=t.byteLength,this._total_chunk_length===this._pending_binary_length)t=this._full_binary.buffer;else return;let n={data:{id:this._pending_binary,data:t}};if(this._pending_port_id!==void 0){let s={port_id:this._pending_port_id,delta:t};n.data.data=s}this._handle(n),delete this._pending_binary,delete this._pending_binary_length,delete this._pending_port_id,this._total_chunk_length=0,this._full_binary=null}else e=JSON.parse(e.data),e.binary_length?(this._pending_binary=e.id,this._pending_binary_length=e.binary_length,e.data&&e.data.port_id!==void 0&&(this._pending_port_id=e.data.port_id),this._full_binary=new Uint8Array(this._pending_binary_length)):this._handle({data:e})}constructor(e){super(),this._ws=e,this._ws.binaryType="arraybuffer",this._full_binary,this._total_chunk_length=0,this._pending_binary_length=0,this._ws.onopen=()=>{this.send({id:-1,cmd:"init"})},this._ping(),this._ws.onclose=this._close.bind(this),this._ws.onmessage=this._onmessage.bind(this)}send(e){if(this._ws.readyState===U.default.CLOSED){console.warn("Websocket connection is already closed.");return}if(e.args&&e.args.length>0&&e.args[0]instanceof ArrayBuffer&&e.args[0].byteLength!==void 0){let t=e;e.binary_length=e.args[0].byteLength,this._ws.send(JSON.stringify(t)),this._ws.send(e.args[0]);return}this._ws.send(JSON.stringify(e))}terminate(){return new Promise(e=>{this._on_close_callback=e,this._ws.close()})}};var I="./perspective.worker.js";async function _e(){let r=new URL(I,import.meta.url);return await(await fetch(r)).text()}function S(r,e){function t(s,l){r.push(l)}function n(s){if(Object.keys(s).length>0)for(let l of e)l({data:s})}return{addEventListener:t,postMessage:n,location:{href:""}}}function C(r){let e=Function("const self = arguments[0];"+r),t=[],n=[];return e(S(t,n)),S(n,t)}var Ae=_e(),ye=async function(){let r=await Ae;if(window.location.protocol.startsWith("file")&&!window.isElectron)return console.warn("file:// protocol does not support Web Workers"),C(r);try{let e=new Blob([r],{type:"application/javascript"}),t=URL.createObjectURL(e);return new Worker(t,{type:"module"})}catch(e){return console.warn("Failed to instantiate worker, falling back to single-threaded runtime",e),C(r)}},T=ye;var Y="./perspective.cpp.wasm";async function ge(){return new URL(Y,import.meta.url)}var $=ge();var G=!1,E=function(){let r;return function(){return r||(r=new class{async worker(){return await T()}async wasm(){let e=await $;if(e instanceof ArrayBuffer&&!e.buffer&&(e=new Uint8Array(e)),e.buffer&&e.buffer instanceof ArrayBuffer)G=!0,length=e.byteLength,this._wasm=e;else if(e instanceof ArrayBuffer)length=e.byteLength,this._wasm=new Uint8Array(e);else{let t=await fetch(e);this._wasm=await t.arrayBuffer()}return this._wasm}}),r}}(),v=class extends h{constructor(e){e&&W(e),super(),this.register()}async register(){let e,t={cmd:"init",config:y()};if(typeof WebAssembly>"u")throw new Error("WebAssembly not supported.");[e,t.buffer]=await Promise.all([E().worker(),E().wasm()]);for(var n in this._worker)e[n]=this._worker[n];this._worker=e,this._worker.addEventListener("message",this._handle.bind(this)),this._worker.postMessage(t),this._detect_transferable()}send(e){this._worker.transferable&&e.args&&e.args[0]instanceof ArrayBuffer?this._worker.postMessage(e,[e.args[0]]):this._worker.postMessage(e)}terminate(){this._worker.terminate(),this._worker=void 0}get transferable(){return this._worker?.transferable||!1}get inline(){return G}_detect_transferable(){var e=new ArrayBuffer(1);this._worker.postMessage(e,[e]),this._worker.transferable=e.byteLength===0}},ve=function(){let r,e;return{getInstance:function(t){r===void 0&&(r=new v(t));let n=JSON.stringify(t);if(e&&n!==e)throw new Error("Configuration object for shared_worker() has changed - this is probably a bug in your application.");return e=n,r}}}(),et=V;function je(r){return E().set(r)}function me(r){return new v(r)}function ke(r=window.location.origin.replace("http","ws")){return new g(new WebSocket(r))}function Oe(r){return ve.getInstance(r)}var tt={override:je,worker:me,websocket:ke,shared_worker:Oe,...Object.keys(O)};export{tt as default,et as get_type_config,je as override,Oe as shared_worker,ke as websocket,me as worker};
//# sourceMappingURL=perspective.js.map
